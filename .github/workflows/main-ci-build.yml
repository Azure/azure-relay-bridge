name: Main and Release CI Build

on:
  workflow_dispatch:
  push:
    branches: [master, main]
    tags:
      - "v*.*"
  pull_request:
    branches: [master, main]

jobs:
  build:
    permissions: write-all
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        include:
          - os: windows-latest
            windows: true
    runs-on: ${{ matrix.os }}

    steps:
      - name: Create artifacts directories
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path "artifacts"
          New-Item -ItemType Directory -Force -Path "artifacts/build"

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Mandatory to use the extract version from tag action

      - name: Extract version from tag
        uses: damienaicheh/extract-version-from-tag-action@v1.0.0

      - name: Extract full version including suffix
        shell: pwsh
        run: |
          if ("${{ github.ref }}" -like "refs/tags/*") {
            # Extract full tag name (e.g., v0.15.1-srk.1)
            $fullTag = "${{ github.ref_name }}"
            # Remove 'v' prefix (e.g., 0.15.1-srk.1)
            $fullVersion = $fullTag -replace '^v', ''
            echo "FULL_VERSION=$fullVersion" >> $env:GITHUB_ENV
            Write-Host "Full version: $fullVersion"
            
            # Extract base version (e.g., 0.15.1)
            $baseVersion = $fullVersion -split '-' | Select-Object -First 1
            echo "BASE_VERSION=$baseVersion" >> $env:GITHUB_ENV
            Write-Host "Base version: $baseVersion"
            
            # Extract suffix if exists (e.g., srk.1)
            if ($fullVersion.Contains('-')) {
              $parts = $fullVersion -split '-', 2
              $suffix = $parts[1]
              echo "SUFFIX=$suffix" >> $env:GITHUB_ENV
              Write-Host "Suffix: $suffix"
            } else {
              echo "SUFFIX=" >> $env:GITHUB_ENV
              Write-Host "No suffix found"
            }
          } else {
            echo "FULL_VERSION=0.0.0-dev" >> $env:GITHUB_ENV
            echo "BASE_VERSION=0.0.0" >> $env:GITHUB_ENV
            echo "SUFFIX=dev" >> $env:GITHUB_ENV
            Write-Host "Using development version"
          }

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Restore dependencies
        run: dotnet restore

      - name: Build Docker Image TAR file
        run: |
          mkdir -p artifacts/build/images 
          # Use full version for revision and base version for main tag
          DOCKER_BUILDKIT=1 docker build . --build-arg "REVISION=${{ env.FULL_VERSION }}" --build-arg "VERSION=${{ env.BASE_VERSION }}" -t azbridge:${{ env.FULL_VERSION }} -t azbridge:${{ env.BASE_VERSION }} -t azbridge
          docker save azbridge:${{ env.FULL_VERSION }} > artifacts/build/images/azbridge-oci-image-${{ env.FULL_VERSION }}.tar
        if: matrix.os == 'ubuntu-latest'

      - name: Build for Windows-x64
        run: dotnet msbuild /t:Package /p:WindowsOnly=true /p:RuntimeIdentifier=win-x64 /p:Configuration=Release /p:TargetFramework=net8.0 /p:VersionSuffix=rel /p:VersionPrefix=${{ env.FULL_VERSION }}
        if: matrix.os == 'windows-latest'
      - name: Build for Windows-arm64
        run: dotnet msbuild /t:Restore,Package /p:WindowsOnly=false /p:RuntimeIdentifier=win-arm64 /p:Configuration=Release /p:TargetFramework=net8.0 /p:VersionSuffix=rel /p:VersionPrefix=${{ env.FULL_VERSION }}
        if: matrix.os == 'windows-latest'
      - name: Build for Windows-x86
        run: dotnet msbuild /t:Restore,Package /p:WindowsOnly=false /p:RuntimeIdentifier=win-x86 /p:Configuration=Release /p:TargetFramework=net8.0 /p:VersionSuffix=rel /p:VersionPrefix=${{ env.FULL_VERSION }}
        if: matrix.os == 'windows-latest'
      - name: Build for macOS-x64
        run: dotnet msbuild /t:Package /p:WindowsOnly=false /p:RuntimeIdentifier=osx-x64 /p:Configuration=Release /p:TargetFramework=net8.0 /p:VersionSuffix=rel /p:VersionPrefix=${{ env.FULL_VERSION }}
        if: matrix.os == 'macos-latest'
      - name: Build for macOS-arm64
        run: dotnet msbuild /t:Package /p:WindowsOnly=false /p:RuntimeIdentifier=osx-arm64 /p:Configuration=Release /p:TargetFramework=net8.0 /p:VersionSuffix=rel /p:VersionPrefix=${{ env.FULL_VERSION }}
        if: matrix.os == 'macos-latest'
      - name: Build for Linux-x64
        run: dotnet msbuild /t:Package /p:WindowsOnly=false /p:RuntimeIdentifier=linux-x64 /p:Configuration=Release /p:TargetFramework=net8.0 /p:VersionSuffix=rel /p:VersionPrefix=${{ env.FULL_VERSION }}
        if: matrix.os == 'ubuntu-latest'
      - name: Build for Linux-arm64
        run: dotnet msbuild /t:Restore,Package /p:WindowsOnly=false /p:RuntimeIdentifier=linux-arm64 /p:Configuration=Release /p:TargetFramework=net8.0 /p:VersionSuffix=rel /p:VersionPrefix=${{ env.FULL_VERSION }}
        if: matrix.os == 'ubuntu-latest'

      - name: Unit Test Windows x64
        env:
          AZBRIDGE_TEST_CXNSTRING: ${{ secrets.AZBRIDGE_TEST_CXNSTRING }}
        run: dotnet test /p:TargetFramework=net8.0 /p:RuntimeIdentifier=win-x64 /p:Configuration=Debug
        if: matrix.os == 'windows-latest'
      - name: Unit Test Linux x64
        env:
          AZBRIDGE_TEST_CXNSTRING: ${{ secrets.AZBRIDGE_TEST_CXNSTRING }}
        run: dotnet test /p:TargetFramework=net8.0 /p:RuntimeIdentifier=linux-x64 /p:Configuration=Debug
        if: matrix.os == 'ubuntu-latest'
      - name: Unit Test macOS arm64
        env:
          AZBRIDGE_TEST_CXNSTRING: ${{ secrets.AZBRIDGE_TEST_CXNSTRING }}
        # W/A for Dns.GetHostEntry(Dns.GetHostName()) exception https://github.com/actions/runner-images/issues/8649
        run: |
          # Get network interface IP and hostname
          IP_ADDR=$(ipconfig getifaddr en0 2>/dev/null || echo "127.0.0.1")
          HOSTNAME_F=$(hostname -f 2>/dev/null || hostname)
          HOSTNAME_S=$(hostname -s 2>/dev/null || hostname)

          # Add to /etc/hosts if not already present
          if ! grep -q "$HOSTNAME_F" /etc/hosts; then
            echo "$IP_ADDR $HOSTNAME_F $HOSTNAME_S" | sudo tee -a /etc/hosts
          fi

          # Run the unblock script if it exists
          if [ -f "./test/unit/macos_unblock_testip.sh" ]; then
            chmod +x ./test/unit/macos_unblock_testip.sh
            ./test/unit/macos_unblock_testip.sh
          fi

          # Set additional DNS resolution workarounds
          export DOTNET_SYSTEM_NET_HTTP_USESOCKETSHTTPHANDLER=0

          # Run tests with retry mechanism
          for i in {1..3}; do
            echo "Test attempt $i..."
            if dotnet test /p:TargetFramework=net8.0 /p:RuntimeIdentifier=osx-arm64 /p:Configuration=Debug; then
              echo "Tests passed on attempt $i"
              break
            else
              echo "Tests failed on attempt $i"
              if [ $i -eq 3 ]; then
                echo "All test attempts failed"
                exit 1
              fi
              sleep 5
            fi
          done
        if: matrix.os == 'macos-latest'

      - uses: actions/upload-artifact@v4
        with:
          name: XBuild-${{ matrix.os }}
          path: artifacts/build/net8.0

      - uses: actions/upload-artifact@v4
        with:
          name: XBuild-Docker-Images-ubuntu-latest
          path: artifacts/build/images
        if: matrix.os == 'ubuntu-latest'

      #- name: Integration Tests Docker/Linux
      #  env:
      #     AZBRIDGE_TEST_CXNSTRING: ${{ secrets.AZBRIDGE_TEST_CXNSTRING }}
      #  run: bash ./verify-build.sh
      #  if: matrix.os == 'ubuntu-latest'

      #- name: Integration Tests Windows
      #  env:
      #     AZBRIDGE_TEST_CXNSTRING: ${{ secrets.AZBRIDGE_TEST_CXNSTRING }}
      #  run: ./verify-build.cmd
      #  if: matrix.os == 'windows-latest'

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: Generate Release
        uses: ncipollo/release-action@v1
        with:
          artifacts: "artifacts/**/*"
          generateReleaseNotes: true
          allowUpdates: true
